{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst base_64_1 = require(\"base-64\");\n\nexports.minTokenValidTime = 60 * 60 * 1000; // 1 hour\n\nfunction fetchToken(baseUrl, projectId, appId, deviceId, fetcher = fetch, nowFn = Date.now) {\n  var _a;\n\n  return __awaiter(this, void 0, void 0, function* () {\n    let body;\n\n    if (projectId !== undefined) {\n      body = {\n        projectId,\n        deviceId\n      };\n    } else {\n      body = {\n        appId,\n        deviceId\n      };\n    }\n\n    const response = yield fetcher(baseUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json'\n      },\n      body: JSON.stringify(body)\n    });\n    const json = yield response.json();\n\n    if (response.status !== 200) {\n      throw Error((_a = json.error) !== null && _a !== void 0 ? _a : `Speechly API login request failed with ${response.status}`);\n    }\n\n    if (json.access_token === undefined) {\n      throw Error('Invalid login response from Speechly API');\n    }\n\n    if (!validateToken(json.access_token, projectId, appId, deviceId, nowFn)) {\n      throw Error('Invalid token received from Speechly API');\n    }\n\n    return json.access_token;\n  });\n}\n\nexports.fetchToken = fetchToken;\n\nfunction validateToken(token, projectId, appId, deviceId, now = Date.now) {\n  const decoded = decodeToken(token);\n\n  if (decoded.expiresAtMs - now() < exports.minTokenValidTime) {\n    return false;\n  }\n\n  if (decoded.appId !== appId || decoded.projectId !== projectId) {\n    return false;\n  }\n\n  if (decoded.deviceId !== deviceId) {\n    return false;\n  }\n\n  return true;\n}\n\nexports.validateToken = validateToken;\n\nfunction decodeToken(token) {\n  const b = token.split('.')[1];\n  let body;\n\n  try {\n    body = JSON.parse(base_64_1.decode(b));\n  } catch (e) {\n    throw new Error('Error decoding Speechly token!');\n  }\n\n  return {\n    appId: body.appId,\n    projectId: body.projectId,\n    deviceId: body.deviceId,\n    configId: body.configId,\n    scopes: body.scope.split(' '),\n    issuer: body.iss,\n    audience: body.aud,\n    expiresAtMs: body.exp * 1000\n  };\n}\n\nexports.decodeToken = decodeToken;","map":{"version":3,"sources":["../../src/websocket/token.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst base_64_1 = require(\"base-64\");\nexports.minTokenValidTime = 60 * 60 * 1000; // 1 hour\nfunction fetchToken(baseUrl, projectId, appId, deviceId, fetcher = fetch, nowFn = Date.now) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function* () {\n        let body;\n        if (projectId !== undefined) {\n            body = { projectId, deviceId };\n        }\n        else {\n            body = { appId, deviceId };\n        }\n        const response = yield fetcher(baseUrl, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(body),\n        });\n        const json = yield response.json();\n        if (response.status !== 200) {\n            throw Error((_a = json.error) !== null && _a !== void 0 ? _a : `Speechly API login request failed with ${response.status}`);\n        }\n        if (json.access_token === undefined) {\n            throw Error('Invalid login response from Speechly API');\n        }\n        if (!validateToken(json.access_token, projectId, appId, deviceId, nowFn)) {\n            throw Error('Invalid token received from Speechly API');\n        }\n        return json.access_token;\n    });\n}\nexports.fetchToken = fetchToken;\nfunction validateToken(token, projectId, appId, deviceId, now = Date.now) {\n    const decoded = decodeToken(token);\n    if (decoded.expiresAtMs - now() < exports.minTokenValidTime) {\n        return false;\n    }\n    if (decoded.appId !== appId || decoded.projectId !== projectId) {\n        return false;\n    }\n    if (decoded.deviceId !== deviceId) {\n        return false;\n    }\n    return true;\n}\nexports.validateToken = validateToken;\nfunction decodeToken(token) {\n    const b = token.split('.')[1];\n    let body;\n    try {\n        body = JSON.parse(base_64_1.decode(b));\n    }\n    catch (e) {\n        throw new Error('Error decoding Speechly token!');\n    }\n    return {\n        appId: body.appId,\n        projectId: body.projectId,\n        deviceId: body.deviceId,\n        configId: body.configId,\n        scopes: body.scope.split(' '),\n        issuer: body.iss,\n        audience: body.aud,\n        expiresAtMs: body.exp * 1000,\n    };\n}\nexports.decodeToken = decodeToken;\n//# sourceMappingURL=token.js.map"]},"metadata":{},"sourceType":"script"}